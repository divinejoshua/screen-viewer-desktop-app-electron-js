<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Screen & Camera Recorder - Browser Version</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .browser-notice {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .browser-notice h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }

        .recorder-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 600px;
            width: 100%;
        }

        .preview-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            min-height: 300px;
        }

        .screen-preview, .camera-preview {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .screen-preview video, .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-preview video {
            transform: scaleX(-1); /* Mirror effect for camera */
        }

        .preview-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .no-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .recording-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: #f44336;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .status {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .status.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: #f44336;
        }

        /* Camera overlay styles */
        .camera-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 12px;
            border: 3px solid #fff;
            z-index: 9999;
            display: none;
            overflow: hidden;
        }

        .camera-overlay video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
        }

        .camera-overlay .overlay-label {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .camera-overlay .overlay-controls {
            position: absolute;
            bottom: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        .camera-overlay .overlay-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .camera-overlay .overlay-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @media (max-width: 768px) {
            .preview-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üé• Screen & Camera Recorder</h1>
            <p>Record your screen and camera simultaneously</p>
        </div>

        <div class="browser-notice">
            <h3>üåê Running in Browser Mode</h3>
            <p>This version works in modern browsers like Chrome, Firefox, Safari, and Edge. Screen sharing should work properly!</p>
        </div>

        <div class="recorder-container">
            <div class="recording-indicator" id="recordingIndicator">
                <div class="recording-dot"></div>
                <span class="timer" id="timer">Recording: 00:00</span>
            </div>

            <div class="preview-container">
                <div class="screen-preview">
                    <div class="preview-label">Screen</div>
                    <video id="screenVideo" autoplay muted playsinline style="display: none;"></video>
                    <div class="no-preview" id="screenNoPreview">No screen capture</div>
                </div>
                
                <div class="camera-preview">
                    <div class="preview-label">Camera</div>
                    <video id="cameraVideo" autoplay muted playsinline style="display: none;"></video>
                    <div class="no-preview" id="cameraNoPreview">No camera</div>
                </div>
            </div>

            <div class="controls">
                <button class="btn btn-secondary" id="startScreenBtn">
                    üì∫ Start Screen
                </button>
                
                <button class="btn btn-secondary" id="startCameraBtn">
                    üì∑ Start Camera
                </button>
                
                <button class="btn btn-secondary" id="combineStreamsBtn">
                    üîó Combine Streams
                </button>
                
                <button class="btn btn-primary" id="startRecordingBtn">
                    ‚è∫Ô∏è Start Recording
                </button>
                
                <button class="btn btn-danger" id="stopRecordingBtn">
                    ‚èπÔ∏è Stop Recording
                </button>
                
                <button class="btn btn-secondary" id="stopAllBtn">
                    üõë Stop All
                </button>
            </div>

            <div class="status" id="status"></div>
        </div>
    </div>

    <!-- Camera Overlay -->
    <div class="camera-overlay" id="cameraOverlay">
        <div class="overlay-label">Camera</div>
        <video id="overlayVideo" autoplay muted playsinline></video>
        <div class="overlay-controls">
            <button class="overlay-btn" id="hideOverlayBtn">Hide</button>
            <button class="overlay-btn" id="showOverlayBtn" style="display: none;">Show</button>
        </div>
    </div>

    <script>
        class ScreenRecorder {
            constructor() {
                this.screenStream = null;
                this.cameraStream = null;
                this.combinedStream = null;
                this.mediaRecorder = null;
                this.recordedChunks = [];
                this.isRecording = false;
                this.recordingTime = 0;
                this.timerInterval = null;
                
                this.initializeElements();
                this.attachEventListeners();
            }

            initializeElements() {
                this.screenVideo = document.getElementById('screenVideo');
                this.cameraVideo = document.getElementById('cameraVideo');
                this.screenNoPreview = document.getElementById('screenNoPreview');
                this.cameraNoPreview = document.getElementById('cameraNoPreview');
                this.recordingIndicator = document.getElementById('recordingIndicator');
                this.timer = document.getElementById('timer');
                this.status = document.getElementById('status');
                
                this.startScreenBtn = document.getElementById('startScreenBtn');
                this.startCameraBtn = document.getElementById('startCameraBtn');
                this.combineStreamsBtn = document.getElementById('combineStreamsBtn');
                this.startRecordingBtn = document.getElementById('startRecordingBtn');
                this.stopRecordingBtn = document.getElementById('stopRecordingBtn');
                this.stopAllBtn = document.getElementById('stopAllBtn');
                
                // Camera overlay elements
                this.cameraOverlay = document.getElementById('cameraOverlay');
                this.overlayVideo = document.getElementById('overlayVideo');
                this.hideOverlayBtn = document.getElementById('hideOverlayBtn');
                this.showOverlayBtn = document.getElementById('showOverlayBtn');
            }

            attachEventListeners() {
                this.startScreenBtn.addEventListener('click', () => this.startScreenCapture());
                this.startCameraBtn.addEventListener('click', () => this.startCameraCapture());
                this.combineStreamsBtn.addEventListener('click', () => this.combineStreams());
                this.startRecordingBtn.addEventListener('click', () => this.startRecording());
                this.stopRecordingBtn.addEventListener('click', () => this.stopRecording());
                this.stopAllBtn.addEventListener('click', () => this.stopAllStreams());
                
                // Camera overlay controls
                this.hideOverlayBtn.addEventListener('click', () => this.hideCameraOverlay());
                this.showOverlayBtn.addEventListener('click', () => this.showCameraOverlay());
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            setStatus(message, type = '') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }

            async startScreenCapture() {
                try {
                    this.setStatus('Requesting screen access...');
                    
                    // Check if getDisplayMedia is supported
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                        throw new Error('Screen sharing is not supported in this browser. Please use Chrome, Firefox, Safari, or Edge.');
                    }
                    
                    this.screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            mediaSource: 'screen',
                            width: { ideal: 1920, max: 1920 },
                            height: { ideal: 1080, max: 1080 },
                            frameRate: { ideal: 30, max: 60 }
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        }
                    });
                    
                    this.screenVideo.srcObject = this.screenStream;
                    this.screenVideo.style.display = 'block';
                    this.screenNoPreview.style.display = 'none';
                    this.setStatus('Screen capture started', 'success');
                    
                    // Handle stream end
                    this.screenStream.getVideoTracks()[0].onended = () => {
                        this.screenStream = null;
                        this.screenVideo.style.display = 'none';
                        this.screenNoPreview.style.display = 'flex';
                        this.setStatus('Screen capture ended');
                    };
                    
                } catch (error) {
                    console.error('Error accessing screen:', error);
                    let errorMessage = error.message;
                    
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'Screen sharing permission denied. Please allow screen sharing and try again.';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'No screen source found. Make sure you have a screen to share.';
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage = 'Screen sharing is not supported. Please use Chrome, Firefox, Safari, or Edge.';
                    } else if (error.name === 'AbortError') {
                        errorMessage = 'Screen sharing was cancelled.';
                    }
                    
                    this.setStatus(`Error: ${errorMessage}`, 'error');
                }
            }

            async startCameraCapture() {
                try {
                    this.setStatus('Requesting camera access...');
                    this.cameraStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            frameRate: { ideal: 30 }
                        },
                        audio: true
                    });
                    
                    this.cameraVideo.srcObject = this.cameraStream;
                    this.cameraVideo.style.display = 'block';
                    this.cameraNoPreview.style.display = 'none';
                    
                    // Also show camera in overlay
                    this.overlayVideo.srcObject = this.cameraStream;
                    this.showCameraOverlay();
                    
                    this.setStatus('Camera capture started', 'success');
                    
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    this.setStatus(`Error: ${error.message}`, 'error');
                }
            }

            combineStreams() {
                if (!this.screenStream || !this.cameraStream) {
                    this.setStatus('Please start both screen and camera capture first', 'error');
                    return;
                }

                try {
                    // Create a canvas to combine the streams
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas size to match screen stream
                    const screenTrack = this.screenStream.getVideoTracks()[0];
                    const screenSettings = screenTrack.getSettings();
                    canvas.width = screenSettings.width || 1920;
                    canvas.height = screenSettings.height || 1080;

                    // Create a new stream from the canvas
                    this.combinedStream = canvas.captureStream(30);
                    
                    // Add audio from screen stream
                    const audioTracks = this.screenStream.getAudioTracks();
                    audioTracks.forEach(track => {
                        this.combinedStream.addTrack(track);
                    });

                    // Draw function to combine video streams
                    const draw = () => {
                        if (this.screenVideo && this.cameraVideo) {
                            // Clear canvas
                            ctx.fillStyle = '#000';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            
                            // Draw screen stream (full size)
                            ctx.drawImage(this.screenVideo, 0, 0, canvas.width, canvas.height);
                            
                            // Draw camera stream (small overlay in bottom right)
                            const cameraSize = Math.min(canvas.width * 0.2, canvas.height * 0.2, 200);
                            const x = canvas.width - cameraSize - 20;
                            const y = canvas.height - cameraSize - 20;
                            
                            // Draw border around camera
                            ctx.strokeStyle = '#fff';
                            ctx.lineWidth = 3;
                            ctx.strokeRect(x - 2, y - 2, cameraSize + 4, cameraSize + 4);
                            
                            // Draw camera video
                            ctx.drawImage(this.cameraVideo, x, y, cameraSize, cameraSize);
                        }
                        
                        if (this.isRecording) {
                            requestAnimationFrame(draw);
                        }
                    };

                    // Start drawing
                    draw();
                    this.setStatus('Streams combined successfully', 'success');
                    
                } catch (error) {
                    console.error('Error combining streams:', error);
                    this.setStatus(`Error combining streams: ${error.message}`, 'error');
                }
            }

            async startRecording() {
                if (!this.combinedStream) {
                    this.setStatus('Please combine streams first', 'error');
                    return;
                }

                try {
                    this.setStatus('Starting recording...');
                    
                    this.recordedChunks = [];
                    
                    // Try different formats for better compatibility
                    let mimeType = 'video/webm;codecs=vp9';
                    if (MediaRecorder.isTypeSupported('video/mp4')) {
                        mimeType = 'video/mp4';
                    } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
                        mimeType = 'video/webm;codecs=vp8';
                    }
                    
                    this.mediaRecorder = new MediaRecorder(this.combinedStream, {
                        mimeType: mimeType
                    });
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.recordedChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        const blob = new Blob(this.recordedChunks, { type: mimeType });
                        this.saveVideo(blob, mimeType);
                    };
                    
                    this.mediaRecorder.start(1000); // Collect data every second
                    this.isRecording = true;
                    this.recordingTime = 0;
                    
                    // Show recording indicator
                    this.recordingIndicator.style.display = 'flex';
                    
                    // Start timer
                    this.timerInterval = setInterval(() => {
                        this.recordingTime++;
                        this.timer.textContent = `Recording: ${this.formatTime(this.recordingTime)}`;
                    }, 1000);
                    
                    this.setStatus('Recording started', 'success');
                    
                } catch (error) {
                    console.error('Error starting recording:', error);
                    this.setStatus(`Error starting recording: ${error.message}`, 'error');
                }
            }

            stopRecording() {
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                    
                    // Hide recording indicator
                    this.recordingIndicator.style.display = 'none';
                    
                    if (this.timerInterval) {
                        clearInterval(this.timerInterval);
                        this.timerInterval = null;
                    }
                    
                    this.setStatus('Recording stopped');
                }
            }

            async saveVideo(blob, mimeType) {
                try {
                    this.setStatus('Saving video...');
                    
                    // Determine file extension based on mime type
                    let extension = 'webm';
                    if (mimeType.includes('mp4')) {
                        extension = 'mp4';
                    } else if (mimeType.includes('webm')) {
                        extension = 'webm';
                    }
                    
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `recording-${Date.now()}.${extension}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.setStatus(`Video downloaded successfully as ${extension.toUpperCase()}`, 'success');
                    
                } catch (error) {
                    console.error('Error saving video:', error);
                    this.setStatus(`Error saving video: ${error.message}`, 'error');
                }
            }

            stopAllStreams() {
                if (this.screenStream) {
                    this.screenStream.getTracks().forEach(track => track.stop());
                    this.screenStream = null;
                    this.screenVideo.style.display = 'none';
                    this.screenNoPreview.style.display = 'flex';
                }
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                    this.cameraVideo.style.display = 'none';
                    this.cameraNoPreview.style.display = 'flex';
                }
                if (this.combinedStream) {
                    this.combinedStream.getTracks().forEach(track => track.stop());
                    this.combinedStream = null;
                }
                if (this.isRecording) {
                    this.stopRecording();
                }
                this.setStatus('All streams stopped');
            }

            showCameraOverlay() {
                this.cameraOverlay.style.display = 'block';
                this.hideOverlayBtn.style.display = 'block';
                this.showOverlayBtn.style.display = 'none';
            }

            hideCameraOverlay() {
                this.cameraOverlay.style.display = 'none';
                this.hideOverlayBtn.style.display = 'none';
                this.showOverlayBtn.style.display = 'block';
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ScreenRecorder();
        });
    </script>
</body>
</html>
